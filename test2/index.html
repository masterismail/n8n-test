<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Report Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for the file input */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-input-label {
            cursor: pointer;
        }

        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Credit Report Analyzer</h1>
            <p class="text-md text-gray-600 mt-2">Upload your credit report PDF to get a summary of payment statuses.
            </p>
        </header>

        <main>
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <div id="upload-section">
                    <div class="flex flex-col items-center justify-center w-full">
                        <label for="pdf-upload"
                            class="file-input-label flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-10 h-10 mb-4 text-gray-500" aria-hidden="true"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2" />
                                </svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span>
                                    or drag and drop</p>
                                <p class="text-xs text-gray-500">PDF file only</p>
                                <p id="file-name" class="text-sm text-blue-600 mt-2"></p>
                            </div>
                            <input id="pdf-upload" type="file" class="hidden" accept="application/pdf" />
                        </label>
                    </div>
                    <div class="mt-6 text-center">
                        <button id="analyze-btn"
                            class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed"
                            disabled>
                            Analyze Report
                        </button>
                    </div>
                </div>

                <div id="loading-section" class="hidden text-center py-12">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto">
                    </div>
                    <p class="mt-4 text-lg font-semibold text-gray-700">Analyzing your report... this may take a moment.
                    </p>
                </div>

                <div id="results-section" class="hidden mt-8">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2">Analysis Summary</h2>
                    <div id="results-content" class="space-y-6"></div>
                </div>
                <div id="error-section"
                    class="hidden mt-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                    <strong class="font-bold">Error:</strong>
                    <span class="block sm:inline" id="error-message"></span>
                </div>
            </div>

            <div class="mt-8 p-6 bg-white rounded-xl shadow-md border border-gray-200">
                <h3 class="text-xl font-semibold mb-4">Payment Status Legend</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-green-500 border border-green-600"></span> OK - Current</div>
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-yellow-500 border border-yellow-600"></span> 30 - 30 Days
                        Late</div>
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-orange-500 border border-orange-600"></span> 60 - 60 Days
                        Late</div>
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-red-500 border border-red-600"></span> 90 - 90 Days Late
                    </div>
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-red-600 border border-red-700"></span> 120 - 120 Days Late
                    </div>
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-red-700 border border-red-800"></span> 150 - 150 Days Late
                    </div>
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-red-800 border border-red-900"></span> 180 - 180 Days Late
                    </div>
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-gray-800 text-white flex items-center justify-center text-xs">CO</span>
                        Chargeoff</div>
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-gray-800 text-white flex items-center justify-center text-xs">RF</span>
                        Repossession</div>
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-gray-800 text-white flex items-center justify-center text-xs">PP</span>
                        Payment Plan</div>
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-gray-800 text-white flex items-center justify-center text-xs">VS</span>
                        Voluntary Surrender</div>
                    <div class="flex items-center"><span
                            class="w-5 h-5 rounded mr-2 bg-gray-200 border border-gray-300"></span> No Data Provided
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>&copy; 2024 Credit Report Analyzer. All analysis is done locally in your browser.</p>
        </footer>
    </div>

    <script>
        // Set the workerSrc for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        const uploadInput = document.getElementById('pdf-upload');
        const analyzeBtn = document.getElementById('analyze-btn');
        const fileNameDisplay = document.getElementById('file-name');

        const uploadSection = document.getElementById('upload-section');
        const loadingSection = document.getElementById('loading-section');
        const resultsSection = document.getElementById('results-section');
        const resultsContent = document.getElementById('results-content');
        const errorSection = document.getElementById('error-section');
        const errorMessage = document.getElementById('error-message');

        let pdfFile = null;

        // --- UI Event Listeners ---
        uploadInput.addEventListener('change', (e) => {
            pdfFile = e.target.files[0];
            if (pdfFile) {
                fileNameDisplay.textContent = pdfFile.name;
                analyzeBtn.disabled = false;
            } else {
                fileNameDisplay.textContent = '';
                analyzeBtn.disabled = true;
            }
        });

        analyzeBtn.addEventListener('click', async () => {
            if (!pdfFile) return;

            // Show loading and hide other sections
            uploadSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            errorSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');

            try {
                const results = await parsePdf(pdfFile);
                displayResults(results);
                resultsSection.classList.remove('hidden');
            } catch (err) {
                console.error("Error processing PDF:", err);
                errorMessage.textContent = err.message || "Could not process the PDF. Please ensure it's a valid credit report and try again.";
                errorSection.classList.remove('hidden');
                uploadSection.classList.remove('hidden'); // Show upload again
            } finally {
                loadingSection.classList.add('hidden');
            }
        });

        // --- Core Logic ---

        const LEGEND = {
            'OK': 'Current',
            '30': '30 Days Late',
            '60': '60 Days Late',
            '90': '90 Days Late',
            '120': '120 Days Late',
            '150': '150 Days Late',
            '180': '180 Days Late',
            'CO': 'Chargeoff or Collection',
            'RF': 'Repossession or Foreclosure',
            'PP': 'Payment Plan',
            'VS': 'Voluntary Surrender',
            'NDP': 'No Data Provided'
        };

        /**
         * Parses the uploaded PDF file to extract payment history.
         * @param {File} file - The PDF file to parse.
         * @returns {Promise<Array>} A promise that resolves with an array of analysis results.
         */
        async function parsePdf(file) {
            const fileReader = new FileReader();
            return new Promise((resolve, reject) => {
                fileReader.onload = async (event) => {
                    try {
                        const typedarray = new Uint8Array(event.target.result);
                        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                        let allTextItems = [];

                        // Extract text from all pages
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            // Add page number to each item for context
                            textContent.items.forEach(item => item.page = i);
                            allTextItems.push(...textContent.items);
                        }

                        const analysisResults = analyzeTextContent(allTextItems);
                        resolve(analysisResults);

                    } catch (err) {
                        reject(new Error("Failed to read or parse the PDF file. It might be corrupted or in an unsupported format."));
                    }
                };
                fileReader.onerror = () => reject(new Error("Failed to read the file."));
                fileReader.readAsArrayBuffer(file);
            });
        }

        /**
         * Analyzes the extracted text items to find payment history grids and issues.
         * @param {Array} textItems - An array of text items from pdf.js.
         * @returns {Array} An array of objects representing accounts with payment issues.
         */
        function analyzeTextContent(textItems) {
            const accounts = [];
            let currentAccount = null;

            // Find all account sections by looking for "Two-Year payment history"
            const paymentHistoryMarkers = textItems.filter(item => item.str.includes('Two-Year payment history'));

            if (paymentHistoryMarkers.length === 0) {
                throw new Error("Could not find any 'Two-Year payment history' sections in the document. The format might not be supported.");
            }

            for (const marker of paymentHistoryMarkers) {
                // Find the account name associated with this history marker.
                // The account name is usually the capitalized word appearing before the history table.
                const potentialAccountNames = textItems
                    .filter(item => item.page === marker.page && item.transform[5] > marker.transform[5] && item.str.trim().length > 2 && item.str.toUpperCase() === item.str)
                    .sort((a, b) => b.transform[5] - a.transform[5]); // Sort by y-position, descending

                let accountName = "Unknown Account";
                if (potentialAccountNames.length > 0) {
                    // Find the closest name above the marker
                    let closestName = null;
                    let minDistance = Infinity;
                    for (const name of potentialAccountNames) {
                        const distance = name.transform[5] - marker.transform[5];
                        if (distance > 0 && distance < minDistance) {
                            minDistance = distance;
                            closestName = name;
                        }
                    }
                    if (closestName) accountName = closestName.str.trim();
                }

                currentAccount = { name: accountName, issues: [] };

                // Define a bounding box for the payment grid based on the marker's position
                const gridTop = marker.transform[5] - 100; // Approx 100 units above marker
                const gridBottom = marker.transform[5] - 20; // Just above the marker
                const gridPage = marker.page;

                const gridItems = textItems.filter(item =>
                    item.page === gridPage &&
                    item.transform[5] < gridBottom &&
                    item.transform[5] > gridTop
                );

                // Parse the grid
                const grid = parsePaymentGrid(gridItems);

                // Analyze the parsed grid for issues
                if (grid.headers.length > 0) {
                    for (const bureau of Object.keys(grid.data)) {
                        grid.data[bureau].forEach((status, index) => {
                            if (status.trim() !== 'OK' && status.trim() !== '') {
                                const header = grid.headers[index] || { month: 'N/A', year: 'N/A' };
                                currentAccount.issues.push({
                                    bureau,
                                    month: header.month,
                                    year: header.year,
                                    status: LEGEND[status.trim()] || `Unknown Code: ${status.trim()}`
                                });
                            }
                        });
                    }
                }
                accounts.push(currentAccount);
            }

            return accounts.filter(acc => acc.issues.length > 0);
        }

        /**
         * Parses a set of text items into a structured payment grid.
         * @param {Array} gridItems - Text items within the grid's bounding box.
         * @returns {Object} A structured object with headers and data.
         */
        function parsePaymentGrid(gridItems) {
            if (gridItems.length === 0) return { headers: [], data: {} };

            // Group items by row (y-coordinate)
            const rows = {};
            gridItems.forEach(item => {
                const y = Math.round(item.transform[5]);
                if (!rows[y]) rows[y] = [];
                rows[y].push(item);
            });

            // Sort rows by y-coordinate (top to bottom)
            const sortedRows = Object.values(rows).sort((a, b) => b[0].transform[5] - a[0].transform[5]);

            const monthRow = sortedRows.find(row => row.some(item => ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].includes(item.str.trim())));
            const yearRow = sortedRows.find(row => row.some(item => /^\d{2}$/.test(item.str.trim())));
            const transUnionRow = sortedRows.find(row => row.some(item => item.str.includes('TransUnion')));
            const experianRow = sortedRows.find(row => row.some(item => item.str.includes('Experian')));
            const equifaxRow = sortedRows.find(row => row.some(item => item.str.includes('Equifax')));

            if (!monthRow || !yearRow) return { headers: [], data: {} };

            // Create headers
            const headers = monthRow.map(monthItem => ({
                month: monthItem.str.trim(),
                x: monthItem.transform[4],
                year: 'N/A'
            })).sort((a, b) => a.x - b.x);

            yearRow.forEach(yearItem => {
                let closestMonthIndex = -1;
                let minDistance = Infinity;
                headers.forEach((header, index) => {
                    const distance = Math.abs(header.x - yearItem.transform[4]);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestMonthIndex = index;
                    }
                });
                if (closestMonthIndex !== -1) {
                    headers[closestMonthIndex].year = `20${yearItem.str.trim()}`;
                }
            });

            const data = {};
            const processBureauRow = (bureauRow, bureauName) => {
                if (!bureauRow) return;
                const statusItems = bureauRow.filter(item => !item.str.includes(bureauName));
                const statuses = Array(headers.length).fill('');
                statusItems.forEach(statusItem => {
                    let closestHeaderIndex = -1;
                    let minDistance = Infinity;
                    headers.forEach((header, index) => {
                        const distance = Math.abs(header.x - statusItem.transform[4]);
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestHeaderIndex = index;
                        }
                    });
                    if (closestHeaderIndex !== -1) {
                        statuses[closestHeaderIndex] = statusItem.str.trim();
                    }
                });
                data[bureauName] = statuses;
            };

            processBureauRow(transUnionRow, 'TransUnion');
            processBureauRow(experianRow, 'Experian');
            processBureauRow(equifaxRow, 'Equifax');

            return { headers, data };
        }

        /**
         * Renders the analysis results to the page.
         * @param {Array} results - The array of accounts with issues.
         */
        function displayResults(results) {
            resultsContent.innerHTML = ''; // Clear previous results

            if (results.length === 0) {
                resultsContent.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg" role="alert">
                        <p class="font-bold">All Clear!</p>
                        <p>We scanned your report and couldn't find any payment history entries that were late or had other negative statuses. All found entries were marked as "OK" (Current).</p>
                    </div>
                `;
                return;
            }

            results.forEach(account => {
                const accountCard = document.createElement('div');
                accountCard.className = 'bg-gray-100 p-4 rounded-lg border';

                let issuesHtml = account.issues.map(issue => `
                    <li class="flex justify-between items-center py-2 border-b last:border-b-0">
                        <span class="font-medium text-gray-700">${issue.bureau} - ${issue.month} ${issue.year}</span>
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(issue.status)}">${issue.status}</span>
                    </li>
                `).join('');

                accountCard.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800">${account.name}</h3>
                    <ul class="mt-3">
                        ${issuesHtml}
                    </ul>
                `;
                resultsContent.appendChild(accountCard);
            });
        }

        /**
         * Returns Tailwind CSS classes for styling the status badge based on its value.
         * @param {string} status - The payment status string.
         * @returns {string} Tailwind CSS classes.
         */
        function getStatusColor(status) {
            if (status.includes('Late')) return 'bg-red-200 text-red-800';
            if (status.includes('Collection') || status.includes('Chargeoff')) return 'bg-gray-800 text-white';
            if (status.includes('Repossession')) return 'bg-purple-200 text-purple-800';
            return 'bg-yellow-200 text-yellow-800';
        }

    </script>
</body>

</html>